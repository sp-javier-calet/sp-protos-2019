
#include "iPhone_Profiler.h"

#include <mach/mach_time.h>
#include <stdio.h>

#define ENABLE_DETAILED_GC_STATS 0

#if ENABLE_INTERNAL_PROFILER

struct UnityFrameStats
{
	typedef signed long long Timestamp;

	Timestamp fixedBehaviourManagerDt;
	Timestamp fixedPhysicsManagerDt;
	Timestamp dynamicBehaviourManagerDt;
	Timestamp coroutineDt;
	Timestamp skinMeshUpdateDt;
	Timestamp animationUpdateDt;
	Timestamp renderDt;
	Timestamp cullingDt;
	Timestamp clearDt;
	int fixedUpdateCount;

	// TODO: add msaa resolve in here

	Timestamp drawCallTime;
	int drawCallCount;
	int triCount;
	int vertCount;

	Timestamp batchDt;
	int batchedDrawCallCount;
	int batchedTris;
	int batchedVerts;
};

extern "C"
{
	int64_t mono_gc_get_used_size();
	int64_t mono_gc_get_heap_size();

	typedef enum
	{
		MONO_GC_EVENT_START,
		MONO_GC_EVENT_MARK_START,
		MONO_GC_EVENT_MARK_END,
		MONO_GC_EVENT_RECLAIM_START,
		MONO_GC_EVENT_RECLAIM_END,
		MONO_GC_EVENT_END,
		MONO_GC_EVENT_PRE_STOP_WORLD,
		MONO_GC_EVENT_POST_STOP_WORLD,
		MONO_GC_EVENT_PRE_START_WORLD,
		MONO_GC_EVENT_POST_START_WORLD
	} MonoGCEvent;

	typedef enum {
		MONO_PROFILE_NONE = 0,
		MONO_PROFILE_APPDOMAIN_EVENTS = 1 << 0,
		MONO_PROFILE_ASSEMBLY_EVENTS  = 1 << 1,
		MONO_PROFILE_MODULE_EVENTS    = 1 << 2,
		MONO_PROFILE_CLASS_EVENTS     = 1 << 3,
		MONO_PROFILE_JIT_COMPILATION  = 1 << 4,
		MONO_PROFILE_INLINING         = 1 << 5,
		MONO_PROFILE_EXCEPTIONS       = 1 << 6,
		MONO_PROFILE_ALLOCATIONS      = 1 << 7,
		MONO_PROFILE_GC               = 1 << 8,
		MONO_PROFILE_THREADS          = 1 << 9,
		MONO_PROFILE_REMOTING         = 1 << 10,
		MONO_PROFILE_TRANSITIONS      = 1 << 11,
		MONO_PROFILE_ENTER_LEAVE      = 1 << 12,
		MONO_PROFILE_COVERAGE         = 1 << 13,
		MONO_PROFILE_INS_COVERAGE     = 1 << 14,
		MONO_PROFILE_STATISTICAL      = 1 << 15,
		MONO_PROFILE_METHOD_EVENTS    = 1 << 16,
		MONO_PROFILE_MONITOR_EVENTS   = 1 << 17,
		MONO_PROFILE_IOMAP_EVENTS     = 1 << 18, /* this should likely be removed, too */
		MONO_PROFILE_GC_MOVES         = 1 << 19,
		MONO_PROFILE_GC_ROOTS         = 1 << 20
	} MonoProfileFlags;

	typedef struct _MonoProfiler MonoProfiler;

	typedef void (*MonoProfileFunc) (MonoProfiler *prof);
	typedef void (*MonoProfileGCFunc)         (MonoProfiler *prof, MonoGCEvent event, int generation);
	typedef void (*MonoProfileGCMoveFunc)     (MonoProfiler *prof, void **objects, int num);
	typedef void (*MonoProfileGCResizeFunc)   (MonoProfiler *prof, int64_t new_size);

	void mono_profiler_install (MonoProfiler *prof, MonoProfileFunc shutdown_callback);
	void mono_profiler_set_events (MonoProfileFlags events);
	void mono_profiler_install_gc (MonoProfileGCFunc callback, MonoProfileGCResizeFunc heap_resize_callback);

	struct _MonoProfiler
	{
		int64_t gc_total_time;
		int64_t gc_mark_time;
		int64_t gc_reclaim_time;
		int64_t gc_stop_world_time;
		int64_t gc_start_world_time;
	};
}

extern bool	_ios43orNewer;

namespace
{
	typedef signed long long	Prof_Int64;

	mach_timebase_info_data_t info;
	void ProfilerInit()
	{
		mach_timebase_info(&info);
	}

	static float MachToMillisecondsDelta (Prof_Int64 delta)
	{
		// Convert to nanoseconds
		delta *= info.numer;
		delta /= info.denom;
		float result = (float)delta / 1000000.0F;
		return result;
	}

	struct ProfilerBlock
	{
		Prof_Int64 maxV, minV, avgV;
	};

	void ProfilerBlock_Update(struct ProfilerBlock* b, Prof_Int64 d, bool reset, bool avoidZero = false)
	{
		if (reset)
		{
			b->maxV = b->minV = b->avgV = d;
		}
		else
		{
			b->maxV = (d > b->maxV)? d : b->maxV;
			if (avoidZero && (b->minV == 0 || d == 0))
				b->minV = (d > b->minV)? d : b->minV;
			else
				b->minV = (d < b->minV)? d : b->minV;
			b->avgV += d;
		}
	}


	int _frameId = 0;

	struct ProfilerBlock _framePB;
	struct ProfilerBlock _presentPB;
	struct ProfilerBlock _gpuPB;
	struct ProfilerBlock _playerPB;
	struct ProfilerBlock _oglesPB;

	struct ProfilerBlock _drawCallCountPB;
	struct ProfilerBlock _triCountPB;
	struct ProfilerBlock _vertCountPB;

	struct ProfilerBlock _batchPB;
	struct ProfilerBlock _batchedDrawCallCountPB;
	struct ProfilerBlock _batchedTriCountPB;
	struct ProfilerBlock _batchedVertCountPB;

	struct ProfilerBlock _fixedBehaviourManagerPB;
	struct ProfilerBlock _fixedPhysicsManagerPB;
	struct ProfilerBlock _dynamicBehaviourManagerPB;
	struct ProfilerBlock _coroutinePB;
	struct ProfilerBlock _skinMeshUpdatePB;
	struct ProfilerBlock _animationUpdatePB;
	struct ProfilerBlock _unityRenderLoopPB;
	struct ProfilerBlock _unityCullingPB;
	struct ProfilerBlock _unityWaitsForGpuPB;
	struct ProfilerBlock _unityMSAAResolvePB;
	struct ProfilerBlock _fixedUpdateCountPB;
	struct ProfilerBlock _GCCountPB;
	struct ProfilerBlock _GCDurationPB;


	Prof_Int64 _gpuDelta			= 0;
	Prof_Int64 _swapStart			= 0;
	Prof_Int64 _lastVBlankTime 		= -1;
	Prof_Int64 _frameStart			= 0;

	Prof_Int64 _msaaResolveStart	= 0;
	Prof_Int64 _msaaResolve			= 0;
	void*	   _msaaResolveCounter	= 0;


	struct UnityFrameStats _unityFrameStats;

	MonoProfiler _monoProfiler;

	static void gc_event(MonoProfiler *profiler, MonoGCEvent event, int generation)
	{
		switch (event) {
			case MONO_GC_EVENT_START:
				profiler->gc_total_time = mach_absolute_time();
				break;
			case MONO_GC_EVENT_END:
			{
				profiler->gc_total_time = mach_absolute_time() - profiler->gc_total_time;
				float delta = profiler->gc_total_time;
				ProfilerBlock_Update(&_GCDurationPB, delta, false);
				ProfilerBlock_Update(&_GCCountPB, 1, false);
				break;
			}
			case MONO_GC_EVENT_MARK_START:
				profiler->gc_mark_time = mach_absolute_time();
				break;
			case MONO_GC_EVENT_MARK_END:
				profiler->gc_mark_time = mach_absolute_time() - profiler->gc_mark_time;
				break;
			case MONO_GC_EVENT_RECLAIM_START:
				profiler->gc_reclaim_time = mach_absolute_time();
				break;
			case MONO_GC_EVENT_RECLAIM_END:
				profiler->gc_reclaim_time = mach_absolute_time() - profiler->gc_reclaim_time;
				break;
			case MONO_GC_EVENT_PRE_STOP_WORLD:
				profiler->gc_stop_world_time = mach_absolute_time();
				break;
			case MONO_GC_EVENT_POST_STOP_WORLD:
				profiler->gc_stop_world_time = mach_absolute_time() - profiler->gc_stop_world_time;
				break;
			case MONO_GC_EVENT_PRE_START_WORLD:
				profiler->gc_start_world_time = mach_absolute_time();
				break;
			case MONO_GC_EVENT_POST_START_WORLD:
				profiler->gc_start_world_time = mach_absolute_time() - profiler->gc_start_world_time;
				break;
			default:
				break;
		}

#if ENABLE_DETAILED_GC_STATS
		if (event == MONO_GC_EVENT_END)
			printf_console("mono-gc>   stop time: %4.1f mark time: %4.1f reclaim time: %4.1f start time: %4.1f total time: %4.1f \n",
				MachToMillisecondsDelta(profiler->gc_stop_world_time),
				MachToMillisecondsDelta(profiler->gc_mark_time),
				MachToMillisecondsDelta(profiler->gc_reclaim_time),
				MachToMillisecondsDelta(profiler->gc_start_world_time),
				MachToMillisecondsDelta(profiler->gc_total_time)
				);
#endif
	}

	static void
	gc_resize (MonoProfiler *profiler, int64_t new_size)
	{
	}

	static void
	profiler_shutdown (MonoProfiler *prof)
	{
	}
}

void Profiler_InitProfiler()
{
	mono_profiler_install (&_monoProfiler, profiler_shutdown);
	mono_profiler_install_gc (gc_event, gc_resize);
	mono_profiler_set_events(MONO_PROFILE_GC);
	ProfilerInit();

	if( _msaaResolveCounter == 0 )
		_msaaResolveCounter = UnityCreateProfilerCounter("iOS.MSAAResolve");
}

void Profiler_UninitProfiler()
{
	UnityDestroyProfilerCounter(_msaaResolveCounter);
}

void
Profiler_FrameStart()
{
	_frameStart = mach_absolute_time();
}

void Profiler_SendInformationToUnity(int eachNthFrame)
{
    char buffer[256];
    sprintf(buffer, "%1.1f;%1.1f;%1.1f;%1.1f;%d;%d;%d;%d;%d;%d;%1.1f;%1.1f;%1.1f;%1.1f;%1.1f;%1.1f;%d;%d;%1.1f;%1.1f;%1.1f;%d;%d;%d;%1.1f",
            MachToMillisecondsDelta(_playerPB.avgV / eachNthFrame),
            MachToMillisecondsDelta(_oglesPB.avgV / eachNthFrame),
            MachToMillisecondsDelta(_presentPB.avgV / eachNthFrame),
            MachToMillisecondsDelta(_framePB.avgV / eachNthFrame),
            (int)(_drawCallCountPB.avgV / eachNthFrame),
            (int)(_batchedDrawCallCountPB.avgV / eachNthFrame),
            (int)(_triCountPB.avgV / eachNthFrame),
            (int)(_batchedTriCountPB.avgV / eachNthFrame),
            (int)(_vertCountPB.avgV / eachNthFrame),
            (int)(_batchedVertCountPB.avgV / eachNthFrame),
            MachToMillisecondsDelta((int)_fixedPhysicsManagerPB.avgV / eachNthFrame),
            MachToMillisecondsDelta((int)_animationUpdatePB.avgV / eachNthFrame),
            MachToMillisecondsDelta((int)_unityCullingPB.avgV / eachNthFrame),
            MachToMillisecondsDelta((int)_skinMeshUpdatePB.avgV / eachNthFrame),
            MachToMillisecondsDelta((int)_batchPB.avgV / eachNthFrame),
#if INCLUDE_OPENGLES_IN_RENDER_TIME
            MachToMillisecondsDelta((int)(_unityRenderLoopPB.avgV - _batchPB.avgV - _unityCullingPB.avgV - _unityWaitsForGpuPB.avgV) / EachNthFrame),
#else
            MachToMillisecondsDelta((int)(_unityRenderLoopPB.avgV - _oglesPB.avgV - _batchPB.avgV - _unityCullingPB.avgV - _unityWaitsForGpuPB.avgV) / eachNthFrame),
#endif
            (int)_fixedUpdateCountPB.minV,
            (int)_fixedUpdateCountPB.maxV,
            MachToMillisecondsDelta(_dynamicBehaviourManagerPB.avgV / eachNthFrame),
            MachToMillisecondsDelta(_fixedBehaviourManagerPB.avgV / eachNthFrame),
            MachToMillisecondsDelta(_coroutinePB.avgV / eachNthFrame),
            (int)mono_gc_get_used_size(),
            (int)mono_gc_get_heap_size(),
            (int)_GCCountPB.avgV,
            MachToMillisecondsDelta(_GCDurationPB.avgV)
            );
    UnitySendMessage("PerformanceTracker", "UpdatePerformanceStats", buffer);
}

void
Profiler_FrameEnd()
{
#if ENABLE_BLOCK_ON_GPU_PROFILER
		Prof_Int64 gpuTime0 = mach_absolute_time();
		UnityFinishRendering();
		Prof_Int64 gpuTime1 = mach_absolute_time();

		_gpuDelta = gpuTime1 - gpuTime0;
#else
		_gpuDelta = 0;
#endif

	_swapStart = mach_absolute_time();
}

void
Profiler_FrameUpdate(const struct UnityFrameStats* unityFrameStats)
{
	_unityFrameStats = *unityFrameStats;

	Prof_Int64 vblankTime = mach_absolute_time();

	static bool firstFrame = true;
	if( firstFrame )
	{
		_lastVBlankTime = vblankTime;
		firstFrame = false;
		return;
	}

	Prof_Int64 frameDelta  = vblankTime - _lastVBlankTime;
	Prof_Int64 swapDelta   = vblankTime - _swapStart;
	Prof_Int64 playerDelta = _swapStart - _frameStart - _gpuDelta - _unityFrameStats.drawCallTime;

	_lastVBlankTime = vblankTime;

	const int EachNthFrame = 30;
	if (_frameId == EachNthFrame)
	{
		_frameId = 0;
        Profiler_SendInformationToUnity(EachNthFrame);
	}
    
	ProfilerBlock_Update(&_framePB, frameDelta, (_frameId == 0));
	ProfilerBlock_Update(&_presentPB, swapDelta, (_frameId == 0));

	ProfilerBlock_Update(&_gpuPB, _gpuDelta, (_frameId == 0), true);
	ProfilerBlock_Update(&_playerPB, playerDelta, (_frameId == 0));
	ProfilerBlock_Update(&_oglesPB, _unityFrameStats.drawCallTime, (_frameId == 0));

	ProfilerBlock_Update(&_drawCallCountPB, _unityFrameStats.drawCallCount, (_frameId == 0));
	ProfilerBlock_Update(&_triCountPB, _unityFrameStats.triCount, (_frameId == 0));
	ProfilerBlock_Update(&_vertCountPB, _unityFrameStats.vertCount, (_frameId == 0));

	ProfilerBlock_Update(&_batchPB, _unityFrameStats.batchDt, (_frameId == 0));
	ProfilerBlock_Update(&_batchedDrawCallCountPB, _unityFrameStats.batchedDrawCallCount, (_frameId == 0));
	ProfilerBlock_Update(&_batchedTriCountPB, _unityFrameStats.batchedTris, (_frameId == 0));
	ProfilerBlock_Update(&_batchedVertCountPB, _unityFrameStats.batchedVerts, (_frameId == 0));

	ProfilerBlock_Update(&_fixedBehaviourManagerPB, _unityFrameStats.fixedBehaviourManagerDt, (_frameId == 0));
	ProfilerBlock_Update(&_fixedPhysicsManagerPB, _unityFrameStats.fixedPhysicsManagerDt, (_frameId == 0));
	ProfilerBlock_Update(&_dynamicBehaviourManagerPB, _unityFrameStats.dynamicBehaviourManagerDt, (_frameId == 0));
	ProfilerBlock_Update(&_coroutinePB, _unityFrameStats.coroutineDt, (_frameId == 0));
	ProfilerBlock_Update(&_skinMeshUpdatePB, _unityFrameStats.skinMeshUpdateDt, (_frameId == 0));
	ProfilerBlock_Update(&_animationUpdatePB, _unityFrameStats.animationUpdateDt, (_frameId == 0));
	ProfilerBlock_Update(&_unityRenderLoopPB, _unityFrameStats.renderDt, (_frameId == 0));
	ProfilerBlock_Update(&_unityCullingPB, _unityFrameStats.cullingDt, (_frameId == 0));
	ProfilerBlock_Update(&_unityMSAAResolvePB, _msaaResolve, (_frameId == 0));
	ProfilerBlock_Update(&_fixedUpdateCountPB, _unityFrameStats.fixedUpdateCount, (_frameId == 0));
	ProfilerBlock_Update(&_GCCountPB, 0, (_frameId == 0));
	ProfilerBlock_Update(&_GCDurationPB, 0, (_frameId == 0));

	if( _ios43orNewer )
		ProfilerBlock_Update(&_unityWaitsForGpuPB, swapDelta, (_frameId == 0));
	else
		ProfilerBlock_Update(&_unityWaitsForGpuPB, _unityFrameStats.clearDt+_msaaResolve, (_frameId == 0));

	_msaaResolve = 0;


	++_frameId;
}

void Profiler_StartMSAAResolve()
{
	UnityStartProfilerCounter(_msaaResolveCounter);
	_msaaResolveStart = mach_absolute_time();
}

void Profiler_EndMSAAResolve()
{
	_msaaResolve += (mach_absolute_time() - _msaaResolveStart);
	UnityEndProfilerCounter(_msaaResolveCounter);
}

#endif // ENABLE_INTERNAL_PROFILER

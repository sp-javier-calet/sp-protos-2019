#bin/sh

CONFIG_FILE=".unity_setup"
DEFAULT_PLATFORM="ios"

print_info_message() {
	printf "$1\n" 1>&2;
}

print_command_message() {
	printf "\033[36m$1\n\033[0m" 1>&2;
}

print_warning_message() {
	printf "\033[33m$1\n\033[0m" 1>&2;
}

print_error_message() {
	printf "\033[31m$1\n\033[0m" 1>&2;
}

get_unity_setup_param () {
	local value=`cat $CONFIG_FILE | grep $1`
	value=${value/#" "/}
	value=${value/#"$1="/}
	echo $value
}

get_unity_setup_param_warning () {
	local value=$(get_unity_setup_param "$1")
	if [[ -z "$value" ]]; then
		print_warning_message "Warning: There's no $1 section in the unity_setup.info file"
	fi
	echo $value
}

get_unity_setup_param_error () {
	local value=$(get_unity_setup_param "$1")
	if [[ -z "$value" ]]; then
		print_error_message "Error: There's no $1 section in the unity_setup.info file"
	fi
	echo $value
}

check_unity_process_running () {
	if pgrep "Unity" > /dev/null
	then
	    print_warning_message "Warning: Running unity instances found"
	    print_command_message "Killing unity instances..."
	    killall Unity
	fi
}

download_package() {
  if [ -f $"$2/`basename "$1"`" ]; then
    print_info_message "$1 Package exists, continuing..."
    return
  fi
  url="http://download.unity3d.com/download_unity/$UNITY_VERSION_HASH/$1"
  print_command_message "Downloading Unity package: $url"
  curl -o "$2/`basename "$1"`" "$url"
}

install_package() {
  print_command_message "Installing $1"
  sudo installer -package "$1" -target /
}

download_and_install_unity_package () {
	download_package "$1" "$2"
	install_package "$2/`basename "$1"`"
}

download_and_install_unity_packages () {
	local TMP_PATH=$(mktemp -d)

	download_and_install_unity_package "MacEditorInstaller/Unity-$UNITY_VERSION.pkg" "$TMP_PATH"

	if [[ $PLATFORMS == *"ios"* ]]
	then
		download_and_install_unity_package "MacEditorTargetInstaller/UnitySetup-iOS-Support-for-Editor-$UNITY_VERSION.pkg" "$TMP_PATH"
	fi
	if [[ $PLATFORMS == *"android"* ]]
	then
		download_and_install_unity_package "MacEditorTargetInstaller/UnitySetup-Android-Support-for-Editor-$UNITY_VERSION.pkg" "$TMP_PATH"
	fi
}

get_unity_version_by_path () {
	echo `/usr/libexec/PlistBuddy "$1/Unity.app/Contents/Info.plist" -c "Print CFBundleVersion"`
}

find_installed_unity_version () {
	print_info_message "Looking for unity installations..."

	local format=""
	local unity_path=""
	local result_found=""
	find /Applications -wholename '/Applications/*Unity*' -maxdepth 1 | while read -r line
	do
		version=$(get_unity_version_by_path "$line")
		if [[ $UNITY_VERSION == $version ]]
		then
			if [[ -z $result_found ]]
			then
				echo $line
				result_found=$line
			fi
			format="\033[32m"
		else
			format=""
		fi
		printf "$format$version:\t$line\033[0m\n" 1>&2
	done
}

setup_library_dir () {
	projectPath=`find . -iname "ProjectSettings" | sed 's/ProjectSettings//g'`
	projectPath="${projectPath}Library"
	if [ ! -e "$projectPath" ]; then
		mkdir "$projectPath"
	fi
	echo $projectPath
}

write_ios_editor_file () {
	library_dir=$(setup_library_dir)
	echo "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T3V0cHV0AG1fU2VsZWN0ZWRXaWlVQm9vdE1vZGUAbV9TZWxlY3RlZFhib3hTdWJ0YXJnZXQAbV9TZWxlY3RlZFhib3hSdW5NZXRob2QAbV9EZXZlbG9wbWVudABtX0Nvbm5lY3RQcm9maWxlcgBtX0FsbG93RGVidWdnaW5nAG1fV2ViUGxheWVyU3RyZWFtZWQAbV9XZWJQbGF5ZXJPZmZsaW5lRGVwbG95bWVudABtX0luc3RhbGxJbkJ1aWxkRm9sZGVyAG1fU3ltbGlua0xpYnJhcmllcwBtX1N5bWxpbmtUcmFtcG9saW5lAG1fU2VsZWN0ZWRJT1NCdWlsZFR5cGUAbV9OZWVkU3VibWlzc2lvbk1hdGVyaWFscwBtX0NvbXByZXNzV2l0aFBzQXJjAG1fRXhwbGljaXROdWxsQ2hlY2tzAG1fRW5hYmxlSGVhZGxlc3NNb2RlAG1fQnVpbGRTY3JpcHRzT25seQBtX1dpaVVFbmFibGVOZXRBUEkAbV9XZWJHTE9wdGltaXphdGlvbkxldmVsAG1fU2VsZWN0ZWRBbmRyb2lkU3VidGFyZ2V0AG1fU2VsZWN0ZWRXU0FTREsAbV9TZWxlY3RlZFdTQVVXUEJ1aWxkVHlwZQBtX1NlbGVjdGVkV1NBQnVpbGRBbmRSdW5EZXBsb3lUYXJnZXQAbV9HZW5lcmF0ZVdTQVJlZmVyZW5jZVByb2plY3RzAG1fV1NBRG90TmV0TmF0aXZlRW5hYmxlZABtX1NlbGVjdGVkQmxhY2tCZXJyeVN1YnRhcmdldABtX1NlbGVjdGVkQmxhY2tCZXJyeUJ1aWxkVHlwZQBtX1NlbGVjdGVkVGl6ZW5TdWJ0YXJnZXQAbV9YYm94T25lU3RyZWFtaW5nSW5zdGFsbExhdW5jaENodW5rUmFuZ2UAbV9TZWxlY3RlZFhib3hPbmVEZXBsb3lNZXRob2QAbV9YYm94T25lVXNlcm5hbWUAbV9YYm94T25lTmV0d29ya1NoYXJlUGF0aABtX0ZvcmNlT3B0aW1pemVTY3JpcHRDb21waWxhdGlvbgABAAAAAAAAAQAAAAAAAAAAAAAAjQAAABsEAAAbBP//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQAAAAQAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAwAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" | base64 --decode -o "$library_dir/EditorUserBuildSettings.asset"
}

write_android_editor_file () {
	library_dir=$(setup_library_dir)
	echo "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T3V0cHV0AG1fU2VsZWN0ZWRXaWlVQm9vdE1vZGUAbV9TZWxlY3RlZFhib3hTdWJ0YXJnZXQAbV9TZWxlY3RlZFhib3hSdW5NZXRob2QAbV9EZXZlbG9wbWVudABtX0Nvbm5lY3RQcm9maWxlcgBtX0FsbG93RGVidWdnaW5nAG1fV2ViUGxheWVyU3RyZWFtZWQAbV9XZWJQbGF5ZXJPZmZsaW5lRGVwbG95bWVudABtX0luc3RhbGxJbkJ1aWxkRm9sZGVyAG1fU3ltbGlua0xpYnJhcmllcwBtX1N5bWxpbmtUcmFtcG9saW5lAG1fU2VsZWN0ZWRJT1NCdWlsZFR5cGUAbV9OZWVkU3VibWlzc2lvbk1hdGVyaWFscwBtX0NvbXByZXNzV2l0aFBzQXJjAG1fRXhwbGljaXROdWxsQ2hlY2tzAG1fRW5hYmxlSGVhZGxlc3NNb2RlAG1fQnVpbGRTY3JpcHRzT25seQBtX1dpaVVFbmFibGVOZXRBUEkAbV9XZWJHTE9wdGltaXphdGlvbkxldmVsAG1fU2VsZWN0ZWRBbmRyb2lkU3VidGFyZ2V0AG1fU2VsZWN0ZWRXU0FTREsAbV9TZWxlY3RlZFdTQVVXUEJ1aWxkVHlwZQBtX1NlbGVjdGVkV1NBQnVpbGRBbmRSdW5EZXBsb3lUYXJnZXQAbV9HZW5lcmF0ZVdTQVJlZmVyZW5jZVByb2plY3RzAG1fV1NBRG90TmV0TmF0aXZlRW5hYmxlZABtX1NlbGVjdGVkQmxhY2tCZXJyeVN1YnRhcmdldABtX1NlbGVjdGVkQmxhY2tCZXJyeUJ1aWxkVHlwZQBtX1NlbGVjdGVkVGl6ZW5TdWJ0YXJnZXQAbV9YYm94T25lU3RyZWFtaW5nSW5zdGFsbExhdW5jaENodW5rUmFuZ2UAbV9TZWxlY3RlZFhib3hPbmVEZXBsb3lNZXRob2QAbV9YYm94T25lVXNlcm5hbWUAbV9YYm94T25lTmV0d29ya1NoYXJlUGF0aABtX0ZvcmNlT3B0aW1pemVTY3JpcHRDb21waWxhdGlvbgABAAAAAAAAAQAAAAAAAAAAAAAAjQAAABsEAAAbBP//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADQAAAAcAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAwAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" | base64 --decode -o "$library_dir/EditorUserBuildSettings.asset"
}

if [ -e "$CONFIG_FILE" ]; then
	unity_path=""
	UNITY_VERSION=$(get_unity_setup_param_error "version")
	UNITY_VERSION_HASH=$(get_unity_setup_param_error "hash")
	PLATFORMS=$(get_unity_setup_param_warning "platforms")
	CACHE_SERVER=$(get_unity_setup_param_warning "cache-server")
	if [ -z "${UNITY_VERSION_HASH}" ] || [ -z "${UNITY_VERSION}" ]; then
		exit 1
	fi

	check_unity_process_running

	unity_path=$(find_installed_unity_version)

	if [ -z "$unity_path" ]; then
		printf "Unable to find the required Unity version ($UNITY_VERSION), proceding to install...\n"
		if [ -e "/Applications/Unity" ]; then
			SHOULD_RESTORE_UNITY_INSTALLATION=true
			mv /Applications/Unity /Applications/Unity-old-tmp
			print_command_message "Moving old unity installation (/Applications/Unity) to /Applications/Unity-old-tmp temporarily (will be restored after install)"
			download_and_install_unity_packages
			print_command_message "Restoring old unity installation location"
			unity_path="/Applications/Unity-${UNITY_VERSION}"
			mv /Applications/Unity "$unity_path"
			mv /Applications/Unity-old-tmp /Applications/Unity
		else
			download_and_install_unity_packages
			unity_path="/Applications/Unity"
		fi
	else
		printf "Required Unity version found: $unity_path ($UNITY_VERSION)\n"
	fi

	if [ ! -z $CACHE_SERVER ]; then
		print_command_message "Setting up cache server $CACHE_SERVER"
		defaults write com.unity3d.UnityEditor5.x CacheServerIPAddress -string "$CACHE_SERVER"
		defaults write com.unity3d.UnityEditor5.x CacheServerEnabled -int 1
	fi

	platform=$1
	if [ -z $platform ]; then
		platform=$DEFAULT_PLATFORM
	fi

	if [[ $1 == *"ios"* ]]
	then
		write_ios_editor_file
	else
		write_android_editor_file
	fi

	printf "\033[32mConfiguration complete! Use \033[36m$unity_path\033[32m unity installation to open the project\n" 1>&2
else
	print_error_message "Could not find $CONFIG_FILE configuration file"
	exit 1
fi